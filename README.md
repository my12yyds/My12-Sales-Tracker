## 微信小程序：主播-销售分组式线索跟进系统（云开发）

### 核心特性
- ✅ **多销售协作**：一条线索可分配给多个销售，支持协作跟进
- ✅ **小组隔离**：4个小组数据完全隔离
- ✅ **角色权限**：主播/销售/管理员三角色权限分离
- ✅ **实时统计**：管理员看板实时统计各小组数据

### 运行方式（开发者工具）
1. 用微信开发者工具导入本项目根目录
2. 开启「云开发」，选择或新建环境
3. 在「云函数」面板上传并部署 `cloudfunctions/` 下所有云函数（首次部署需要安装依赖）
4. 数据库会自动创建集合（首次调用云函数时）

### 目录结构
```
miniprogram/          小程序端
  ├── pages/          页面
  │   ├── anchor/     主播端页面
  │   ├── sales/      销售端页面
  │   ├── admin/      管理员端页面
  │   └── ...
  └── utils/          工具函数
cloudfunctions/       云函数（后端）
  ├── authLogin       登录/用户初始化
  ├── leadCreate      创建线索（主播）
  ├── leadList        获取线索列表
  ├── leadAssignSales 分配销售（支持多销售）
  ├── followUpCreate  创建跟进记录（销售）
  ├── followUpList    获取跟进记录列表
  └── adminDashboard  管理员数据看板
docs/                 需求/设计文档
```

### 角色定义（数字枚举）
- `role = 0`：管理员（仅查看全量数据与看板，无写权限）
- `role = 1`：主播（录入本组线索、查看本组线索、分配销售）
- `role = 2`：销售（查看分配给自己的线索、填写跟进记录）

### 小组隔离与多销售协作
- **小组隔离**：`groupId` 1~4（固定 4 组）
  - 主播只能访问自己 `groupId` 下的线索
  - 销售只能访问自己 `groupId` 且 `assignedSalesIds` 包含自己的线索
  - 管理员可查看全量，但不允许录入/跟进写操作

- **多销售协作**：
  - 线索表 `leads` 包含 `assignedSalesIds` 数组字段
  - 主播录入线索时可选择多个销售（不选则自动分配最少负载的销售）
  - 主播可以后续添加/移除销售（通过 `leadAssignSales` 云函数）
  - 多个销售可以同时对同一条线索添加跟进记录

### 数据库集合
- `users`：用户表（role: 0管理员/1主播/2销售，groupId: 1~4）
- `leads`：线索表（groupId, assignedSalesIds数组，状态字段等）
- `followUps`：跟进记录表（leadId, salesId, 跟进时间/状态/备注等）

### 快速开始
1. **初始化用户**：首次登录会自动创建用户（默认 role=2 销售，groupId=1）
2. **设置角色**：在数据库 `users` 表中手动修改用户的 `role` 和 `groupId`
   - 管理员：`role = 0`，`groupId` 可为 0 或空
   - 主播：`role = 1`，`groupId = 1~4`
   - 销售：`role = 2`，`groupId = 1~4`
3. **开始使用**：
   - 主播：录入线索 → 查看本组线索
   - 销售：查看我的线索 → 添加跟进记录
   - 管理员：查看数据看板

### 注意事项
- 所有权限校验在云函数中实现，前端隐藏仅作体验优化
- 销售ID必须在云函数中强制设置，不接受前端传入
- 小组隔离通过 `groupId` 字段在云函数查询条件中强制实现

文件里面有安装文档
# 微信小程序线索跟进系统 - 安装指导

## 一、环境要求

- 微信开发者工具（最新版本）
- 微信小程序账号（已注册并获取 AppID）
- 云开发环境（需要开通）

## 二、准备工作

### 1. 获取 AppID
- 登录 [微信公众平台](https://mp.weixin.qq.com/)
- 进入小程序管理后台
- 在「开发」→「开发管理」→「开发设置」中获取 AppID

### 2. 配置 AppID
打开 `project.config.json` 文件，将 `appid` 修改为你的小程序 AppID：
```json
{
  "appid": "你的小程序AppID",
  ...
}
```

### 3. 配置云开发环境
打开 `miniprogram/app.js` 文件，将云环境 ID 修改为你的云开发环境 ID：
```javascript
wx.cloud.init({
  env: "你的云开发环境ID",
  traceUser: true
});
```

## 三、安装步骤

### 步骤 1：导入项目

1. 打开微信开发者工具
2. 选择「导入项目」
3. 选择本项目根目录（包含 `miniprogram` 和 `cloudfunctions` 文件夹的目录）
4. 输入项目名称，选择 AppID
5. 点击「导入」

### 步骤 2：开通云开发

1. 在微信开发者工具中，点击顶部菜单「云开发」
2. 点击「开通」按钮
3. 创建云开发环境（如果还没有）
   - 环境名称：自定义（如：prod、dev）
   - 环境 ID：系统自动生成，复制此 ID
   - 将环境 ID 配置到 `miniprogram/app.js` 中
4. 等待环境初始化完成（约 1-2 分钟）

### 步骤 3：部署云函数

需要部署以下云函数（按顺序部署）：

#### 3.1 部署 authLogin（登录/用户初始化）
1. 在微信开发者工具中，点击左侧「云函数」面板
2. 右键点击 `cloudfunctions/authLogin` 文件夹
3. 选择「上传并部署：云端安装依赖」
4. 等待部署完成（首次部署需要安装依赖，约 1-2 分钟）

#### 3.2 部署其他云函数
按照相同方式部署以下云函数：
- `adminUserList` - 管理员用户列表
- `adminUserUpdate` - 管理员更新用户
- `adminDashboard` - 管理员数据看板
- `userDetail` - 用户详情
- `userStats` - 用户统计
- `leadCreate` - 创建线索
- `leadList` - 获取线索列表
- `leadAssignSales` - 分配销售
- `leadDelete` - 删除线索
- `leadDetail` - 线索详情
- `followUpCreate` - 创建跟进记录
- `followUpList` - 获取跟进记录列表

**注意**：每个云函数首次部署时都需要选择「上传并部署：云端安装依赖」

### 步骤 4：配置数据库权限

1. 在微信开发者工具中，点击「云开发」→「数据库」
2. 数据库集合会在首次调用云函数时自动创建，包括：
   - `users` - 用户表
   - `leads` - 线索表
   - `followUps` - 跟进记录表

3. 为每个集合设置权限：
   - 点击集合名称
   - 点击「权限设置」
   - 选择「仅创建者可读写」（或根据需求自定义）

### 步骤 5：创建管理员账号

1. 首次登录小程序会自动创建用户账号（默认 role=2 销售，groupId=1）
2. 在云开发控制台的「数据库」中，找到 `users` 集合
3. 找到你的用户记录，点击「编辑」
4. 修改以下字段：
   - `role`: 改为 `0`（管理员）
   - `groupId`: 改为 `0` 或保持原值
   - `name`: 设置管理员姓名
5. 保存修改

### 步骤 6：测试运行

1. 在微信开发者工具中点击「编译」按钮
2. 小程序会自动打开
3. 使用管理员账号登录
4. 测试以下功能：
   - 登录/注册
   - 用户管理（管理员）
   - 创建线索（主播）
   - 添加跟进（销售）
   - 查看数据看板（管理员）

## 四、功能说明

### 角色权限

- **管理员（role=0）**：
  - 查看所有用户和线索
  - 编辑用户角色和小组
  - 查看数据看板
  - 删除线索

- **主播（role=1）**：
  - 录入本组线索
  - 查看本组线索列表
  - 分配销售给线索
  - 删除本组线索
  - 对本组线索添加跟进记录

- **销售（role=2）**：
  - 查看分配给自己的线索
  - 对分配的线索添加跟进记录

### 小组隔离

- 系统支持 4 个小组（groupId: 1-4）
- 每个小组的数据完全隔离
- 主播只能看到本组的线索
- 销售只能看到本组且分配给自己的线索

### 状态管理

线索状态包括：
- 未联系（NEW）
- 已联系（CONTACTED）
- 已报价（QUOTED）
- 成交（WON）
- 流失（LOST）

## 五、常见问题

### Q1: 云函数部署失败
**解决方案**：
- 检查网络连接
- 确认云开发环境已开通
- 检查云函数代码是否有语法错误
- 尝试删除云函数后重新部署

### Q2: 数据库权限错误
**解决方案**：
- 在云开发控制台检查数据库权限设置
- 确保集合权限允许当前用户操作
- 检查云函数中的权限校验逻辑

### Q3: 登录后无法看到数据
**解决方案**：
- 检查用户角色和小组设置
- 确认数据库中有对应的数据
- 检查云函数日志查看错误信息

### Q4: 水印显示问题
**解决方案**：
- 水印已自动添加到所有页面底部
- 如果看不到，检查页面是否有足够的滚动空间
- 水印样式在 `app.wxss` 中定义

## 六、目录结构说明

```
qiche/
├── miniprogram/              # 小程序前端代码
│   ├── pages/                # 页面目录
│   │   ├── login/           # 登录页
│   │   ├── register/        # 注册页
│   │   ├── home/            # 首页
│   │   ├── profile/         # 个人中心
│   │   ├── anchor/          # 主播端页面
│   │   │   ├── leads/       # 线索列表
│   │   │   └── lead-edit/   # 录入线索
│   │   ├── sales/           # 销售端页面
│   │   │   └── leads/      # 我的线索
│   │   ├── admin/           # 管理员端页面
│   │   │   ├── users/       # 用户管理
│   │   │   ├── dashboard/   # 数据看板
│   │   │   └── group-leads/ # 小组线索
│   │   ├── lead-detail/     # 线索详情
│   │   ├── followup-edit/   # 跟进编辑
│   │   └── user-detail/     # 用户详情
│   ├── utils/               # 工具函数
│   │   ├── auth.js          # 认证相关
│   │   ├── date.js          # 日期格式化
│   │   └── status.js        # 状态映射
│   ├── app.js               # 小程序入口
│   ├── app.json             # 小程序配置
│   └── app.wxss             # 全局样式
├── cloudfunctions/          # 云函数目录
│   ├── authLogin/          # 登录/用户初始化
│   ├── adminUserList/      # 管理员用户列表
│   ├── adminUserUpdate/    # 管理员更新用户
│   ├── adminDashboard/     # 管理员数据看板
│   ├── userDetail/        # 用户详情
│   ├── userStats/          # 用户统计
│   ├── leadCreate/         # 创建线索
│   ├── leadList/           # 获取线索列表
│   ├── leadAssignSales/    # 分配销售
│   ├── leadDelete/         # 删除线索
│   ├── leadDetail/         # 线索详情
│   ├── followUpCreate/     # 创建跟进记录
│   └── followUpList/       # 获取跟进记录列表
├── project.config.json      # 项目配置
└── 安装指导.md              # 本文件
```

## 七、更新日志

### v1.0.0
- ✅ 完成基础功能开发
- ✅ 实现多销售协作
- ✅ 实现小组隔离
- ✅ 实现角色权限管理
- ✅ 添加状态中文显示
- ✅ 添加页面水印（my12yyds）
- ✅ 美化所有页面样式

## 八、技术支持

如有问题，请检查：
1. 微信开发者工具控制台错误信息
2. 云开发控制台的云函数日志
3. 数据库权限设置
4. 网络连接状态

---

**开发者：my12yyds**

