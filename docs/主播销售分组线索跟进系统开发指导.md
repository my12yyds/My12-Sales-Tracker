## 一、系统概述

本系统为**主播-销售分组式客户线索跟进管理系统**，核心目标是实现线索的**按小组隔离存储**、**实时跟进记录**及**多角色权限管控**。系统支持 **4 个小组（每组 1 名主播 + 4 名销售）**，小组间线索完全隔离；管理员端可查看全量线索与跟进状态统计，但**不具备录入/跟进写入权限**。

## 二、系统架构
- **云开发平台**：微信小程序云开发
- **前端**：小程序页面（主播/销售/管理员三端同一个小程序，不同角色显示不同入口）
- **后端**：云函数（统一鉴权与权限校验）
- **数据库**：云开发数据库

## 三、角色与权限（数字枚举）
- `role = 0`：管理员（只读看板/全量列表）
- `role = 1`：主播（本组录入线索、查看本组线索）
- `role = 2`：销售（查看分配给自己的线索、添加跟进）

## 四、核心功能

### 4.1 线索录入（主播）
- 主播录入客户**电话**（可扩展姓名/来源/备注）
- 自动关联主播 `groupId`
- 线索创建后可分配给本组**一个或多个销售**（支持多销售协作模式）
- 分配策略：可手动选择销售，或自动按最少负载分配

### 4.2 线索隔离（按组）
- 不同组线索互不可见
- 所有查询/写入以云函数权限为准（前端隐藏仅作体验优化）

### 4.3 跟进记录（销售）
- 销售可以对“分配给自己”（在 `assignedSalesIds` 中）的线索新增跟进
- **多销售协作**：多个销售可以同时对同一条线索添加跟进记录
- 跟进字段：时间、状态、备注
- 写入跟进后更新线索的 `lastFollowUpAt/lastStatus`

### 4.4 管理员数据看板
统计各小组：
- 线索总数
- 已跟进率（有至少 1 条跟进的线索 / 总线索）
- 按状态分布（如 NEW/CONTACTED/QUOTED/WON/LOST）

## 五、数据库设计

### 5.1 用户表 `users`
```js
{
  _id: String,
  openid: String,        // 唯一
  role: Number,          // 0管理员 1主播 2销售
  groupId: Number,       // 1~4；管理员可为空或0
  name: String,
  createdAt: Date,
  updatedAt: Date
}
```
索引：`openid` 唯一索引；`groupId+role` 可选索引（用于分配销售时查本组销售）

### 5.2 线索表 `leads`
```js
{
  _id: String,
  groupId: Number,          // 1~4
  phone: String,
  createdByAnchorId: String,// 录入主播 users._id
  assignedSalesId: String,  // 主负责人销售 users._id（向后兼容，可选）
  assignedSalesIds: Array,  // 分配的销售ID数组 [users._id, ...]（支持多销售协作）
  status: String,           // NEW/CONTACTED/QUOTED/WON/LOST
  remarks: String,
  createdAt: Date,
  updatedAt: Date,
  firstFollowUpAt: Date,
  lastFollowUpAt: Date,
  lastStatus: String,
  wonAt: Date,
  lostAt: Date,
  followUpCount: Number
}
```
索引建议：
- `groupId`
- `assignedSalesId`（向后兼容）
- `assignedSalesIds`（数组索引，用于查询分配给某销售的所有线索）
- 复合：`groupId + createdAt`

### 5.3 跟进表 `followUps`
```js
{
  _id: String,
  leadId: String,        // leads._id
  groupId: Number,       // 冗余便于统计
  salesId: String,       // users._id（销售）
  followUpDate: Date,
  status: String,
  remarks: String,
  createdAt: Date
}
```
索引建议：
- `leadId + followUpDate`
- `groupId + createdAt`

## 六、云函数（建议清单）
- `authLogin`：openid -> users 初始化/返回 role/groupId
- `leadCreate`：主播录入电话 -> 可指定分配销售（单个或多个）
- `leadAssignSales`：分配/添加销售到线索（主播可操作，支持多销售）
- `leadList`：按角色返回列表（主播=本组；销售=分配给我；管理员=全量）
- `leadDetail`：线索详情（含跟进列表摘要/统计）
- `followUpCreate`：销售新增跟进（校验：销售ID在 assignedSalesIds 中）
- `followUpList`：某线索跟进列表
- `adminDashboard`：管理员看板统计

### 6.1 多销售协作权限说明
- **查询权限**：销售只能查看 `assignedSalesIds` 中包含自己ID的线索
- **跟进权限**：销售只能对 `assignedSalesIds` 中包含自己ID的线索添加跟进
- **分配权限**：主播可以为本组线索分配/添加/移除销售（在 assignedSalesIds 中操作）
- **管理员权限**：只读，可查看所有线索和跟进记录

