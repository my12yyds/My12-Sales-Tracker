# 微信小程序销售跟进系统开发指导文档

## 一、系统概述

### 1.1 项目目标
构建一个基于微信小程序云开发的销售跟进管理系统，实现销售人员对客户信息的维护和跟进记录的录入，以及老板对所有销售数据的查看和统计分析。

### 1.2 技术架构
- **云开发平台**：微信小程序云开发（CloudBase）
- **前端框架**：微信小程序原生框架（WXML + WXSS + JavaScript）
- **后端服务**：云函数（Node.js）
- **数据库**：云开发数据库（MongoDB风格）

---

## 二、数据库设计

### 2.1 用户表（users）

**表结构：**
```javascript
{
  _id: String,           // 用户唯一标识（系统自动生成）
  openid: String,        // 微信用户标识（唯一索引）
  role: Number,          // 用户角色：0=老板，1=员工（销售人员）
  name: String,          // 用户昵称/姓名（可选）
  createdAt: Date,       // 创建时间
  updatedAt: Date        // 更新时间
}
```

**字段说明：**
- `role`: 
  - `0` = 老板（可查看所有数据）
  - `1` = 员工/销售人员（只能查看和操作自己的数据）

**索引建议：**
- `openid`: 唯一索引（用于快速查找用户）

---

### 2.2 客户表（customers）

**表结构：**
```javascript
{
  _id: String,           // 客户唯一标识（系统自动生成）
  userId: String,        // 关联销售用户的_id（归属销售）
  phone: String,         // 客户电话
  address: String,       // 客户地址
  remarks: String,       // 客户备注
  createdAt: Date,       // 创建时间
  updatedAt: Date,       // 更新时间
  lastFollowUpAt: Date,  // 最近跟进时间（用于列表排序）
  lastStatus: String     // 最近跟进状态（用于列表展示）
}
```

**索引建议：**
- `userId`: 普通索引（用于查询某销售的所有客户）
- `createdAt`: 普通索引（用于时间排序）

---

### 2.3 跟进记录表（followUps）

**表结构：**
```javascript
{
  _id: String,           // 跟进记录唯一标识（系统自动生成）
  customerId: String,    // 关联客户的_id
  userId: String,        // 关联销售用户的_id
  followUpDate: Date,    // 跟进日期
  status: String,        // 跟进状态（见状态枚举）
  remarks: String,       // 跟进备注
  createdAt: Date        // 创建时间
}
```

**索引建议：**
- `customerId`: 普通索引（用于查询某客户的所有跟进记录）
- `userId`: 普通索引（用于查询某销售的所有跟进记录）
- `followUpDate`: 普通索引（用于时间排序和统计）

---

### 2.4 跟进状态枚举

**状态值定义：**
- `NEW`: 未联系
- `CONTACTED`: 已联系
- `QUOTED`: 已报价
- `WON`: 成交
- `LOST`: 流失

---

## 三、时间统计功能设计

### 3.1 时间统计维度

系统需要统计客户跟进流程的各个时间节点，用于分析销售效率和客户转化周期。

**统计指标：**
1. **客户创建到首次跟进的时间**：`首次跟进时间 - 客户创建时间`
2. **首次跟进到成交的时间**：`成交时间 - 首次跟进时间`
3. **客户创建到成交的总时间**：`成交时间 - 客户创建时间`
4. **平均跟进间隔时间**：`(最后跟进时间 - 首次跟进时间) / 跟进次数`
5. **各状态停留时长**：每个状态从开始到结束的时间

### 3.2 数据库字段补充

**客户表（customers）新增字段：**
```javascript
{
  // ... 原有字段 ...
  firstFollowUpAt: Date,    // 首次跟进时间
  wonAt: Date,              // 成交时间（status为WON时记录）
  lostAt: Date,             // 流失时间（status为LOST时记录）
  totalFollowUpCount: Number // 总跟进次数（用于计算平均间隔）
}
```

**跟进记录表（followUps）新增字段：**
```javascript
{
  // ... 原有字段 ...
  durationFromLast: Number  // 距离上次跟进的天数（首次跟进为0）
}
```

### 3.3 时间统计逻辑

**在新增跟进记录时（云函数 followUpCreate）：**
1. 查询该客户是否已有跟进记录
   - 如果没有：设置 `customers.firstFollowUpAt = 当前时间`
   - 如果有：计算 `durationFromLast = 当前时间 - 上次跟进时间`
2. 更新 `customers.lastFollowUpAt = 当前时间`
3. 更新 `customers.lastStatus = 当前跟进状态`
4. 更新 `customers.totalFollowUpCount += 1`
5. 如果状态为 `WON`：设置 `customers.wonAt = 当前时间`
6. 如果状态为 `LOST`：设置 `customers.lostAt = 当前时间`

**时间统计计算公式：**
- 客户创建到首次跟进：`firstFollowUpAt - createdAt`（天）
- 首次跟进到成交：`wonAt - firstFollowUpAt`（天）
- 客户创建到成交：`wonAt - createdAt`（天）
- 平均跟进间隔：`(lastFollowUpAt - firstFollowUpAt) / totalFollowUpCount`（天）

---

## 四、云函数设计

### 4.1 认证与用户管理

#### authLogin - 用户登录/初始化
**功能**：微信登录，自动创建用户（如果不存在）

**请求参数：**
```javascript
// 无需参数，从云开发上下文获取 openid
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    userId: String,      // 用户_id
    openid: String,      // 微信openid
    role: Number,        // 0=老板，1=员工
    name: String         // 用户昵称
  }
}
```

**业务逻辑：**
1. 从云开发上下文获取 `openid`
2. 查询 `users` 表，`openid == 当前openid`
3. 如果不存在：
   - 创建新用户，默认 `role = 1`（员工）
   - 从微信用户信息获取 `name`（如果有）
4. 返回用户信息

**权限说明：**
- 所有用户都可以调用
- 首次登录自动创建账户

---

### 4.2 客户管理

#### customerCreate - 创建客户
**功能**：销售人员创建新客户

**请求参数：**
```javascript
{
  phone: String,      // 客户电话（必填）
  address: String,    // 客户地址
  remarks: String     // 客户备注
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    _id: String,
    userId: String,
    phone: String,
    address: String,
    remarks: String,
    createdAt: Date
  }
}
```

**业务逻辑：**
1. 验证用户身份（必须是 `role = 1` 的员工）
2. 验证必填字段（phone）
3. 创建客户记录，`userId` 强制设置为当前用户 `_id`
4. 设置 `createdAt = 当前时间`
5. 返回创建的客户信息

**权限说明：**
- 仅 `role = 1`（员工）可以创建
- `userId` 必须在云函数中强制设置，不接受前端传入

---

#### customerUpdate - 更新客户
**功能**：更新客户信息

**请求参数：**
```javascript
{
  customerId: String,  // 客户_id（必填）
  phone: String,       // 客户电话
  address: String,     // 客户地址
  remarks: String      // 客户备注
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    _id: String,
    // ... 更新后的客户信息
  }
}
```

**业务逻辑：**
1. 验证用户身份
2. 查询客户记录
3. 权限校验：
   - 如果 `role = 1`（员工）：必须 `customer.userId == 当前userId`
   - 如果 `role = 0`（老板）：可以更新任意客户
4. 更新客户信息
5. 设置 `updatedAt = 当前时间`
6. 返回更新后的客户信息

**权限说明：**
- 员工只能更新自己的客户
- 老板可以更新所有客户的客户

---

#### customerDelete - 删除客户
**功能**：删除客户（同时删除该客户的所有跟进记录）

**请求参数：**
```javascript
{
  customerId: String  // 客户_id（必填）
}
```

**返回数据：**
```javascript
{
  success: true,
  message: "删除成功"
}
```

**业务逻辑：**
1. 验证用户身份
2. 查询客户记录
3. 权限校验（同 customerUpdate）
4. 删除该客户的所有跟进记录（`followUps` 表中 `customerId == 当前customerId`）
5. 删除客户记录
6. 返回成功信息

**权限说明：**
- 员工只能删除自己的客户
- 老板可以删除所有客户的客户

---

#### customerList - 获取客户列表
**功能**：获取客户列表（根据角色返回不同数据）

**请求参数：**
```javascript
{
  page: Number,        // 页码（默认1）
  pageSize: Number,    // 每页数量（默认10）
  status: String,      // 筛选状态（可选，如"WON"）
  userId: String       // 筛选销售（可选，仅老板可用）
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    list: [
      {
        _id: String,
        userId: String,
        phone: String,
        address: String,
        remarks: String,
        lastFollowUpAt: Date,
        lastStatus: String,
        totalFollowUpCount: Number,
        // ... 时间统计字段
      }
    ],
    total: Number,     // 总数量
    page: Number,
    pageSize: Number
  }
}
```

**业务逻辑：**
1. 验证用户身份
2. 构建查询条件：
   - 如果 `role = 1`（员工）：`userId == 当前userId`
   - 如果 `role = 0`（老板）：可查询所有，支持 `userId` 筛选
3. 如果传入 `status`：查询 `lastStatus == status` 的客户
4. 分页查询
5. 返回列表数据

**权限说明：**
- 员工只能查看自己的客户
- 老板可以查看所有客户的客户，支持按销售筛选

---

#### customerDetail - 获取客户详情
**功能**：获取客户详细信息（包含跟进记录）

**请求参数：**
```javascript
{
  customerId: String  // 客户_id（必填）
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    customer: {
      _id: String,
      userId: String,
      phone: String,
      address: String,
      remarks: String,
      createdAt: Date,
      firstFollowUpAt: Date,
      lastFollowUpAt: Date,
      lastStatus: String,
      wonAt: Date,
      lostAt: Date,
      totalFollowUpCount: Number
    },
    followUps: [
      {
        _id: String,
        followUpDate: Date,
        status: String,
        remarks: String,
        durationFromLast: Number
      }
    ],
    timeStats: {
      daysToFirstFollowUp: Number,    // 创建到首次跟进天数
      daysToWon: Number,              // 创建到成交天数（如果已成交）
      daysFromFirstToWon: Number,     // 首次跟进到成交天数（如果已成交）
      avgFollowUpInterval: Number     // 平均跟进间隔天数
    }
  }
}
```

**业务逻辑：**
1. 验证用户身份
2. 查询客户记录
3. 权限校验（同 customerList）
4. 查询该客户的所有跟进记录（按时间倒序）
5. 计算时间统计指标
6. 返回客户详情和时间统计

**权限说明：**
- 员工只能查看自己的客户详情
- 老板可以查看所有客户的客户详情

---

### 4.3 跟进记录管理

#### followUpCreate - 创建跟进记录
**功能**：为客户创建跟进记录

**请求参数：**
```javascript
{
  customerId: String,   // 客户_id（必填）
  followUpDate: Date,   // 跟进日期（必填）
  status: String,       // 跟进状态（必填，见状态枚举）
  remarks: String       // 跟进备注
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    _id: String,
    customerId: String,
    userId: String,
    followUpDate: Date,
    status: String,
    remarks: String,
    createdAt: Date
  }
}
```

**业务逻辑：**
1. 验证用户身份（必须是 `role = 1` 的员工）
2. 查询客户记录，验证客户是否存在
3. 权限校验：`customer.userId == 当前userId`（员工只能为自己的客户创建跟进）
4. 查询该客户的上一条跟进记录（如果有）
5. 计算 `durationFromLast`：
   - 如果没有上一条：`durationFromLast = 0`
   - 如果有：`durationFromLast = 当前时间 - 上一条跟进时间`（天）
6. 创建跟进记录，`userId` 强制设置为当前用户 `_id`
7. 更新客户表：
   - 如果 `firstFollowUpAt` 为空：设置 `firstFollowUpAt = 当前时间`
   - 更新 `lastFollowUpAt = 当前时间`
   - 更新 `lastStatus = status`
   - 更新 `totalFollowUpCount += 1`
   - 如果 `status == "WON"`：设置 `wonAt = 当前时间`
   - 如果 `status == "LOST"`：设置 `lostAt = 当前时间`
8. 返回创建的跟进记录

**权限说明：**
- 仅 `role = 1`（员工）可以创建
- 员工只能为自己的客户创建跟进记录

---

#### followUpListByCustomer - 获取客户的跟进记录列表
**功能**：获取某个客户的所有跟进记录

**请求参数：**
```javascript
{
  customerId: String,  // 客户_id（必填）
  page: Number,        // 页码（默认1）
  pageSize: Number     // 每页数量（默认10）
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    list: [
      {
        _id: String,
        followUpDate: Date,
        status: String,
        remarks: String,
        durationFromLast: Number,
        createdAt: Date
      }
    ],
    total: Number,
    page: Number,
    pageSize: Number
  }
}
```

**业务逻辑：**
1. 验证用户身份
2. 查询客户记录，验证客户是否存在
3. 权限校验（同 customerDetail）
4. 查询该客户的所有跟进记录（按时间倒序）
5. 返回列表数据

**权限说明：**
- 员工只能查看自己客户的跟进记录
- 老板可以查看所有客户的跟进记录

---

### 4.4 老板报表功能

#### reportOverview - 综合报表
**功能**：老板查看所有销售的统计数据

**请求参数：**
```javascript
{
  startDate: Date,     // 开始日期（可选）
  endDate: Date,       // 结束日期（可选）
  userId: String       // 筛选特定销售（可选）
}
```

**返回数据：**
```javascript
{
  success: true,
  data: {
    summary: {
      totalCustomers: Number,        // 总客户数
      totalFollowUps: Number,        // 总跟进次数
      wonCustomers: Number,          // 成交客户数
      lostCustomers: Number,         // 流失客户数
      avgDaysToWon: Number           // 平均成交天数
    },
    salesStats: [
      {
        userId: String,
        userName: String,
        customerCount: Number,       // 客户数
        followUpCount: Number,       // 跟进次数
        wonCount: Number,            // 成交数
        lostCount: Number,           // 流失数
        avgDaysToWon: Number         // 平均成交天数
      }
    ],
    timeStats: {
      avgDaysToFirstFollowUp: Number,    // 平均首次跟进天数
      avgDaysFromFirstToWon: Number,     // 平均首次跟进到成交天数
      avgFollowUpInterval: Number        // 平均跟进间隔天数
    }
  }
}
```

**业务逻辑：**
1. 验证用户身份（必须是 `role = 0` 的老板）
2. 构建查询条件（时间范围、销售筛选）
3. 聚合统计：
   - 总客户数、总跟进次数
   - 成交客户数（`lastStatus == "WON"`）
   - 流失客户数（`lastStatus == "LOST"`）
   - 平均成交天数（`wonAt - createdAt` 的平均值）
4. 按销售分组统计
5. 计算时间统计指标
6. 返回报表数据

**权限说明：**
- 仅 `role = 0`（老板）可以调用

---

## 五、小程序页面设计

### 5.1 页面结构

```
pages/
├── login/
│   └── index          # 登录页面（自动登录）
├── home/
│   └── index          # 首页（根据角色跳转）
├── customers/
│   ├── list           # 客户列表页
│   ├── detail         # 客户详情页
│   └── edit           # 客户编辑页（新增/编辑）
├── followups/
│   ├── list           # 跟进记录列表页
│   └── create         # 创建跟进记录页
└── boss/
    ├── customers      # 老板-客户列表页
    ├── report         # 老板-报表页
    └── sales-detail   # 老板-销售详情页
```

### 5.2 页面功能说明

#### 5.2.1 登录页面（pages/login/index）
- **功能**：自动调用云函数 `authLogin`，获取用户信息
- **跳转逻辑**：
  - 如果 `role = 1`（员工）：跳转到 `pages/customers/list`
  - 如果 `role = 0`（老板）：跳转到 `pages/boss/customers`

#### 5.2.2 客户列表页（pages/customers/list）
- **功能**：展示当前销售的客户列表
- **显示字段**：客户电话、地址、最近跟进时间、最近跟进状态
- **操作**：
  - 点击客户：跳转到客户详情页
  - 添加客户：跳转到客户编辑页（新增模式）
- **数据来源**：调用云函数 `customerList`

#### 5.2.3 客户详情页（pages/customers/detail）
- **功能**：展示客户详细信息和时间统计
- **显示内容**：
  - 客户基本信息（电话、地址、备注）
  - 时间统计（创建到首次跟进、创建到成交等）
  - 跟进记录列表
- **操作**：
  - 编辑客户：跳转到客户编辑页（编辑模式）
  - 删除客户：调用云函数 `customerDelete`
  - 添加跟进：跳转到创建跟进记录页
- **数据来源**：调用云函数 `customerDetail`

#### 5.2.4 客户编辑页（pages/customers/edit）
- **功能**：新增或编辑客户信息
- **表单字段**：电话（必填）、地址、备注
- **操作**：
  - 保存：调用云函数 `customerCreate` 或 `customerUpdate`
  - 取消：返回上一页
- **模式**：通过页面参数 `customerId` 区分新增/编辑模式

#### 5.2.5 跟进记录列表页（pages/followups/list）
- **功能**：展示某个客户的所有跟进记录
- **显示字段**：跟进日期、状态、备注、距离上次跟进天数
- **数据来源**：调用云函数 `followUpListByCustomer`

#### 5.2.6 创建跟进记录页（pages/followups/create）
- **功能**：为某个客户创建跟进记录
- **表单字段**：
  - 跟进日期（必填，日期选择器）
  - 跟进状态（必填，下拉选择）
  - 跟进备注（文本域）
- **操作**：
  - 保存：调用云函数 `followUpCreate`
  - 取消：返回上一页
- **数据来源**：通过页面参数 `customerId` 传入

#### 5.2.7 老板-客户列表页（pages/boss/customers）
- **功能**：展示所有销售的客户列表
- **显示字段**：客户电话、地址、所属销售、最近跟进时间、最近跟进状态
- **筛选功能**：
  - 按销售筛选（下拉选择）
  - 按状态筛选（下拉选择）
- **操作**：
  - 点击客户：跳转到客户详情页（老板模式）
  - 查看报表：跳转到报表页
- **数据来源**：调用云函数 `customerList`（老板权限）

#### 5.2.8 老板-报表页（pages/boss/report）
- **功能**：展示综合统计数据
- **显示内容**：
  - 总览数据（总客户数、总跟进次数、成交数、流失数等）
  - 各销售统计数据（列表形式）
  - 时间统计指标（平均首次跟进天数、平均成交天数等）
- **筛选功能**：
  - 时间范围选择（开始日期、结束日期）
  - 按销售筛选（可选）
- **数据来源**：调用云函数 `reportOverview`

---

## 六、权限控制实现要点

### 6.1 云函数权限校验标准流程

**每个云函数必须包含以下步骤：**

1. **获取用户身份**
   ```javascript
   const wxContext = cloud.getWXContext();
   const openid = wxContext.OPENID;
   const user = await db.collection('users').where({ openid }).get();
   if (user.data.length === 0) {
     return { success: false, message: '用户不存在' };
   }
   const currentUser = user.data[0];
   const { _id: userId, role } = currentUser;
   ```

2. **角色权限校验**
   - 如果操作需要特定角色（如老板报表），检查 `role === 0`
   - 如果操作需要员工角色（如创建客户），检查 `role === 1`

3. **数据权限校验**
   - 如果 `role === 1`（员工）：
     - 查询条件必须包含 `userId == 当前userId`
     - 写入操作必须强制设置 `userId = 当前userId`（不接受前端传入）
   - 如果 `role === 0`（老板）：
     - 可以查询所有数据
     - 可以操作所有数据（根据业务需求决定是否允许修改）

4. **数据写入时的强制设置**
   ```javascript
   // 创建客户时，强制设置userId
   const customerData = {
     userId: userId,  // 强制使用云函数中的userId，不接受前端传入
     phone: event.phone,
     address: event.address,
     remarks: event.remarks,
     createdAt: new Date()
   };
   ```

### 6.2 前端权限控制（辅助）

**前端可以根据用户角色隐藏/显示功能按钮，但必须配合云函数的权限校验：**

```javascript
// 在页面中根据role显示不同内容
if (userRole === 0) {
  // 显示老板专属功能
} else if (userRole === 1) {
  // 显示员工功能
}
```

**重要**：前端隐藏只是UI层面的优化，真正的权限控制必须在云函数中实现。

---

## 七、时间统计实现细节

### 7.1 时间字段更新时机

**在创建跟进记录时（followUpCreate）：**

```javascript
// 1. 查询客户信息
const customer = await db.collection('customers').doc(customerId).get();

// 2. 查询该客户的上一条跟进记录
const lastFollowUp = await db.collection('followUps')
  .where({ customerId })
  .orderBy('followUpDate', 'desc')
  .limit(1)
  .get();

// 3. 计算距离上次跟进的天数
let durationFromLast = 0;
if (lastFollowUp.data.length > 0) {
  const lastDate = lastFollowUp.data[0].followUpDate;
  const currentDate = new Date(followUpDate);
  durationFromLast = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
}

// 4. 创建跟进记录
const followUpData = {
  customerId,
  userId,
  followUpDate: new Date(followUpDate),
  status,
  remarks,
  durationFromLast,
  createdAt: new Date()
};
await db.collection('followUps').add({ data: followUpData });

// 5. 更新客户表的时间字段
const updateData = {
  lastFollowUpAt: new Date(followUpDate),
  lastStatus: status,
  totalFollowUpCount: (customer.data.totalFollowUpCount || 0) + 1,
  updatedAt: new Date()
};

// 如果是首次跟进
if (!customer.data.firstFollowUpAt) {
  updateData.firstFollowUpAt = new Date(followUpDate);
}

// 如果状态是成交
if (status === 'WON') {
  updateData.wonAt = new Date(followUpDate);
}

// 如果状态是流失
if (status === 'LOST') {
  updateData.lostAt = new Date(followUpDate);
}

await db.collection('customers').doc(customerId).update({ data: updateData });
```

### 7.2 时间统计计算（customerDetail）

```javascript
// 计算时间统计指标
const timeStats = {};

if (customer.firstFollowUpAt) {
  // 创建到首次跟进天数
  timeStats.daysToFirstFollowUp = Math.floor(
    (customer.firstFollowUpAt - customer.createdAt) / (1000 * 60 * 60 * 24)
  );
}

if (customer.wonAt) {
  // 创建到成交天数
  timeStats.daysToWon = Math.floor(
    (customer.wonAt - customer.createdAt) / (1000 * 60 * 60 * 24)
  );
  
  // 首次跟进到成交天数
  if (customer.firstFollowUpAt) {
    timeStats.daysFromFirstToWon = Math.floor(
      (customer.wonAt - customer.firstFollowUpAt) / (1000 * 60 * 60 * 24)
    );
  }
}

// 平均跟进间隔天数
if (customer.totalFollowUpCount > 1 && customer.firstFollowUpAt && customer.lastFollowUpAt) {
  timeStats.avgFollowUpInterval = Math.floor(
    (customer.lastFollowUpAt - customer.firstFollowUpAt) / 
    (1000 * 60 * 60 * 24) / 
    (customer.totalFollowUpCount - 1)
  );
}
```

### 7.3 报表时间统计（reportOverview）

```javascript
// 聚合查询成交客户
const wonCustomers = await db.collection('customers')
  .where({
    lastStatus: 'WON',
    // ... 其他筛选条件
  })
  .get();

// 计算平均成交天数
let totalDaysToWon = 0;
let count = 0;
wonCustomers.data.forEach(customer => {
  if (customer.wonAt && customer.createdAt) {
    totalDaysToWon += Math.floor(
      (customer.wonAt - customer.createdAt) / (1000 * 60 * 60 * 24)
    );
    count++;
  }
});

const avgDaysToWon = count > 0 ? Math.floor(totalDaysToWon / count) : 0;
```

---

## 八、开发步骤建议

### 8.1 第一阶段：基础功能
1. 创建云开发项目，初始化数据库
2. 实现 `authLogin` 云函数（用户登录/初始化）
3. 实现 `customerCreate`、`customerList`、`customerDetail`、`customerUpdate`、`customerDelete`
4. 实现小程序端：登录页、客户列表页、客户详情页、客户编辑页
5. 测试员工角色的客户管理功能

### 8.2 第二阶段：跟进记录功能
1. 实现 `followUpCreate`、`followUpListByCustomer` 云函数
2. 实现时间统计逻辑（更新客户表的时间字段）
3. 实现小程序端：跟进记录列表页、创建跟进记录页
4. 在客户详情页展示时间统计信息
5. 测试跟进记录和时间统计功能

### 8.3 第三阶段：老板功能
1. 实现 `reportOverview` 云函数
2. 实现小程序端：老板客户列表页、报表页
3. 测试老板角色的数据查看和统计功能

### 8.4 第四阶段：优化和完善
1. 添加数据验证和错误处理
2. 优化UI/UX
3. 添加加载状态和错误提示
4. 性能优化（索引优化、分页优化）
5. 测试所有功能场景

---

## 九、注意事项

### 9.1 数据安全
- **所有权限校验必须在云函数中实现**，不能依赖前端
- **userId 必须在云函数中强制设置**，不能接受前端传入
- 敏感操作（删除、修改）需要二次确认

### 9.2 性能优化
- 合理使用数据库索引（userId、customerId、followUpDate等）
- 大数据量查询使用分页
- 报表统计考虑使用云数据库的聚合查询

### 9.3 用户体验
- 提供清晰的加载状态提示
- 操作成功后给出反馈
- 错误信息要友好易懂
- 时间显示格式要统一（如：YYYY-MM-DD）

### 9.4 数据一致性
- 删除客户时，需要同时删除该客户的所有跟进记录
- 更新客户的时间统计字段时，要确保数据准确性
- 跟进记录的状态变更要及时更新客户表的 `lastStatus`

---

## 十、测试要点

### 10.1 权限测试
- 员工只能查看和操作自己的客户和跟进记录
- 老板可以查看所有数据
- 员工创建客户时，userId 是否正确设置为当前用户

### 10.2 时间统计测试
- 首次跟进时，`firstFollowUpAt` 是否正确设置
- 成交时，`wonAt` 是否正确设置
- 时间统计计算是否准确
- 平均跟进间隔计算是否正确

### 10.3 数据完整性测试
- 删除客户时，跟进记录是否同步删除
- 客户信息更新后，时间统计是否仍然准确
- 跟进记录创建后，客户表的时间字段是否正确更新

---

## 附录：数据库索引建议

### users 表
- `openid`: 唯一索引

### customers 表
- `userId`: 普通索引
- `createdAt`: 普通索引
- `lastStatus`: 普通索引（用于状态筛选）
- `lastFollowUpAt`: 普通索引（用于时间排序）

### followUps 表
- `customerId`: 普通索引
- `userId`: 普通索引
- `followUpDate`: 普通索引
- 复合索引：`(customerId, followUpDate)`（用于查询某客户的跟进记录并排序）

---

**文档版本**：v1.0  
**最后更新**：2024年
